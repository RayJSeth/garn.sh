#!/usr/bin/env bash
set -euo pipefail

if command -v subl >/dev/null 2>&1; then
  echo "sublime-text is already installed."
  exit 0
fi

echo "sublime-text not found. Attempting to install..."
echo "Escalating to su..."

sudo -v
while true; do
  sudo -n true
  sleep 60
  kill -0 "$$" || exit
done 2>/dev/null &

echo "Determining architecture..."

ARCH=${ARCH:-$(uname -m)}
case "$ARCH" in
  x86_64) ARCH='x86_64' ;;
  aarch64|arm64) ARCH='aarch64' ;;
  armv7l) ARCH='armv7l' ;;
  *) echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
esac

echo "Architecture is $ARCH"

install_sublime_text_with_pkgmgr() {
  if command -v apt-get >/dev/null 2>&1; then
    wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | sudo apt-key add -
    sudo apt-get install -y apt-transport-https
    echo "deb https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime-text.list
    sudo apt-get update
    sudo apt-get install -y sublime-text
    return 0
  elif command -v dnf >/dev/null 2>&1; then
    sudo rpm -v --import https://download.sublimetext.com/sublimehq-rpm-pub.gpg
    sudo dnf config-manager addrepo --from-repofile=https://download.sublimetext.com/rpm/stable/$ARCH/sublime-text.repo
    sudo dnf install -y sublime-text
    return 0
  elif command -v yum >/dev/null 2>&1; then
    sudo rpm -v --import https://download.sublimetext.com/sublimehq-rpm-pub.gpg
    sudo yum-config-manager --add-repo https://download.sublimetext.com/rpm/stable/$ARCH/sublime-text.repo
    sudo yum install -y sublime-text
    return 0
  elif command -v pacman >/dev/null 2>&1; then
    pacman-key --init
    curl -O https://download.sublimetext.com/sublimehq-pub.gpg && sudo pacman-key --add sublimehq-pub.gpg && sudo pacman-key --lsign-key 8A8F901A && rm sublimehq-pub.gpg
    echo -e "\n[sublime-text]\nServer = https://download.sublimetext.com/arch/stable/$ARCH" | sudo tee -a /etc/pacman.conf
    sudo pacman -Syu --noconfirm sublime-text
  else
    return 1
  fi
}

if install_sublime_text_with_pkgmgr; then
  echo "sublime-text installed successfully via package manager."
  exit 0
fi

echo "No supported package manager found or sublime-text package unavailable."
exit 1
